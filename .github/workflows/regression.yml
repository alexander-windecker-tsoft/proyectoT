name: ðŸ”„ CI & Regression - Continuous Integration & Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecutar manualmente
    inputs:
      run_regression:
        description: 'Run full regression tests'
        required: false
        default: false
        type: boolean
      target_environment:
        description: 'Target environment for regression'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '20'
  
jobs:
  # Job 1: VerificaciÃ³n de cÃ³digo y linting
  code-quality:
    name: ðŸ” Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§¹ ESLint check
        run: npm run lint

      - name: ðŸ”¨ TypeScript build check
        run: npm run build

  # Job 2: Tests estÃ¡ndar (dev/staging)
  tests:
    name: ðŸ§ª Standard Tests (Dev/Staging)
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        environment: [dev, staging]
        browser: [chromium, firefox, webkit]
    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ—ï¸ Build application
        run: npm run build

      - name: ðŸ§ª Run Playwright tests
        env:
          TEST_ENV: ${{ matrix.environment }}
        run: npx playwright test --project=${{ matrix.browser }}

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.environment }}-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 30

  # Job 3: Tests de regresiÃ³n completos (ALL tests)
  regression-tests:
    name: ðŸ”„ Regression Suite (ALL Tests - All Environments)
    runs-on: ubuntu-latest
    needs: [code-quality, tests]
    if: github.ref == 'refs/heads/main' || github.event.inputs.run_regression == 'true'
    strategy:
      matrix:
        environment: ${{ github.event.inputs.target_environment == 'all' && fromJson('["dev", "staging", "prod"]') || fromJson(format('["{0}"]', github.event.inputs.target_environment || 'dev')) }}
        browser: [chromium, firefox]
    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ—ï¸ Build application
        run: npm run build

      - name: ðŸ”„ Run REGRESSION SUITE (ALL tests)
        env:
          TEST_ENV: ${{ matrix.environment }}
        run: |
          echo "ðŸ”„ Running COMPLETE REGRESSION SUITE for ${{ matrix.environment }}"
          echo "ðŸŒ Browser: ${{ matrix.browser }}"
          echo "ðŸ“‹ Test Type: ALL TESTS (not just @regression tagged)"
          
          # Ejecutar TODOS los tests (regresiÃ³n completa)
          npx playwright test --project=${{ matrix.browser }}

      - name: ðŸ“Š Upload regression test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-report-${{ matrix.environment }}-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
          retention-days: 60

  # Job 4: Tests de smoke en producciÃ³n (solo en main)
  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    runs-on: ubuntu-latest
    needs: [code-quality, tests, regression-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ðŸ’¨ Run smoke tests
        env:
          TEST_ENV: prod
        run: npm run test:smoke

      - name: ðŸ“Š Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 30

  # Job 5: Reporte consolidado de CI y RegresiÃ³n
  test-report:
    name: ðŸ“‹ CI & Regression Report Summary
    runs-on: ubuntu-latest
    needs: [tests, regression-tests, smoke-tests]
    if: always()
    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: ðŸ“Š Generate consolidated report
        run: |
          echo "## ðŸ§ª CI & Regression Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Environment | Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for report in ./reports/*/; do
            if [ -d "$report" ]; then
              dirname=$(basename "$report")
              
              # Determinar tipo de test
              if [[ "$dirname" == *"regression"* ]]; then
                test_type="ðŸ”„ Regression Suite"
              elif [[ "$dirname" == *"smoke"* ]]; then
                test_type="ðŸ’¨ Smoke Tests"
              else
                test_type="ðŸ§ª Standard CI"
              fi
              
              # Determinar ambiente
              if [[ "$dirname" == *"dev"* ]]; then
                env="ðŸ”§ Dev"
              elif [[ "$dirname" == *"staging"* ]]; then
                env="ðŸš€ Staging"
              elif [[ "$dirname" == *"prod"* ]]; then
                env="ðŸŽ¯ Prod"
              else
                env="â“ Unknown"
              fi
              
              # Determinar browser
              if [[ "$dirname" == *"chromium"* ]]; then
                browser="ðŸŒ Chromium"
              elif [[ "$dirname" == *"firefox"* ]]; then
                browser="ðŸ¦Š Firefox"
              elif [[ "$dirname" == *"webkit"* ]]; then
                browser="ðŸŽ Safari"
              else
                browser="ðŸ§ª All"
              fi
              
              echo "| $test_type | $env | $browser | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Full reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Standard CI Tests**: Quick validation across dev/staging environments" >> $GITHUB_STEP_SUMMARY
          echo "- **Regression Suite**: COMPLETE test suite across ALL environments (main branch or manual)" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke Tests**: Critical path validation in production environment (main only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Regression Testing Info" >> $GITHUB_STEP_SUMMARY
          echo "- Regression runs **ALL tests** (not just @regression tagged)" >> $GITHUB_STEP_SUMMARY
          echo "- Executes across dev, staging, and prod environments" >> $GITHUB_STEP_SUMMARY
          echo "- Can be triggered manually via 'Run workflow' button" >> $GITHUB_STEP_SUMMARY
