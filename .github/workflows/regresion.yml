name: ğŸ”„ Regression BÃ¡sica

run-name: ${{ github.actor }} ejecutÃ³ Tests de RegresiÃ³n en ${{ github.ref_name }}

on:
  push:
    branches: 
      - main
      - QA
  pull_request:
    branches:
      - main
      - QA

# Permisos necesarios para comentar en PRs
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  playwright-regression:
    name: ğŸ§ª Playwright Regression Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint check
        run: npm run lint

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ­ Install Playwright browsers
        run: |
          npx playwright install chromium --with-deps
          npx playwright install-deps

      - name: ğŸ” Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: carpeta dist no encontrada! El build fallÃ³."
            exit 1
          fi
          echo "âœ… Artefactos de build encontrados"
          ls -la dist/

      - name: ğŸ§ª Run Playwright regression tests
        env:
          CI: true
          PORT: 3000
          HOST: 0.0.0.0
          TEST_ENV: dev
          PLAYWRIGHT_BASE_URL: http://localhost:3000
        run: |
          echo "ğŸ§ª EJECUCIÃ“N DE TESTS DE REGRESIÃ“N"
          echo "ğŸŒ Rama: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Ejecutado por: ${{ github.actor }}"
          echo "ğŸ§ª Navegador: Chromium"
          echo "ğŸ“‹ Ejecutando suite de tests de regresiÃ³n (excluyendo tests @demo)"
          echo "============================================"
          
          # Crear directorios de reportes
          mkdir -p test-results
          mkdir -p playwright-report
          
          # Ejecutar tests de regresiÃ³n usando npm script (excluyendo @demo que fallan intencionalmente)
          npm run test:regression:dev:ci:no-demo

      - name: ğŸ“¸ Capture failure screenshots
        if: failure()
        run: |
          echo "ğŸ“¸ Capturando evidencia de fallos..."
          find test-results -name "*.png" -o -name "*.webm" | head -10
          
          # Listar archivos de trace si existen
          find test-results -name "trace.zip" | head -5

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-results-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            playwright-report/
            test-results/
            **/*.png
            **/*.webm
            **/*.zip
          retention-days: 14

      - name: ğŸ“‹ Generate test summary
        if: always()
        run: |
          echo "# ğŸ”„ RESULTADOS DE TESTS DE REGRESIÃ“N" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rama:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**ID de EjecuciÃ³n:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar resultados
          if [ -f "test-results/results.json" ]; then
            # Instalar jq si no estÃ¡ disponible
            which jq || sudo apt-get install -y jq
            
            passed=$(cat test-results/results.json | jq '.stats.passed' 2>/dev/null || echo "0")
            failed=$(cat test-results/results.json | jq '.stats.failed' 2>/dev/null || echo "0")
            skipped=$(cat test-results/results.json | jq '.stats.skipped' 2>/dev/null || echo "0")
            
            echo "## ğŸ“Š EstadÃ­sticas de Tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Estado | Cantidad |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Aprobados | $passed |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Fallidos | $failed |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Omitidos | $skipped |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$failed" -gt 0 ]; then
              echo "## âŒ REGRESIÃ“N FALLÃ“" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- âš ï¸ $failed test(s) fallaron" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ” Revisa los reportes de tests para detalles" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ“ Artefactos disponibles para descarga" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš« **NO FUSIONAR** hasta que los tests pasen" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… REGRESIÃ“N APROBADA" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ¯ Todos los tests pasaron exitosamente" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš€ Listo para despliegue" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ’ª Calidad de cÃ³digo validada" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âš ï¸ NO SE ENCONTRARON RESULTADOS DE TESTS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No se pudo encontrar el archivo de resultados de tests. Revisa los logs del workflow." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Reportes HTML detallados disponibles en artefactos del workflow**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let status = 'âœ… Todos los tests pasaron';
            let emoji = 'âœ…';
            
            // Check for failures
            try {
              if (fs.existsSync('test-results/results.json')) {
                const data = JSON.parse(fs.readFileSync('test-results/results.json', 'utf8'));
                if (data.stats.failed > 0) {
                  status = `âŒ ${data.stats.failed} test(s) fallaron`;
                  emoji = 'âŒ';
                }
              }
            } catch (e) {
              console.log('No se pudo leer los resultados de tests');
              status = 'âš ï¸ No se pudo determinar el estado de los tests';
              emoji = 'âš ï¸';
            }
            
            const summary = `## ${emoji} Resultados de Tests de RegresiÃ³n
            
            **Estado:** ${status}
            **Rama:** ${{ github.ref_name }}
            **Ejecutado por:** ${{ github.actor }}
            
            [ğŸ“Š Ver reporte detallado](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ§ª Cobertura de Tests
            - âœ… Flujos de login
            - âœ… Operaciones CRUD  
            - âœ… Acceso basado en roles
            - âœ… Validaciones de formularios
            - âœ… Componentes UI/UX
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
    