name: ğŸ”„ Regression BÃ¡sica

run-name: ${{ github.actor }} triggered Regression Test on ${{ github.ref_name }}

on:
  push:
    branches: 
      - main
      - QA
  pull_request:
    branches:
      - main
      - QA

env:
  NODE_VERSION: '20'

jobs:
  playwright-regression:
    name: ğŸ§ª Playwright Regression Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint check
        run: npm run lint

      - name: ğŸ—ï¸ Build application
        run: npm run build

      - name: ğŸ­ Install Playwright browsers
        run: |
          npx playwright install chromium --with-deps
          npx playwright install-deps

      - name: ğŸ” Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist folder not found! Build failed."
            exit 1
          fi
          echo "âœ… Build artifacts found"
          ls -la dist/

      - name: ğŸ§ª Run Playwright regression tests
        env:
          CI: true
          PORT: 3000
          HOST: 0.0.0.0
          TEST_ENV: dev
          PLAYWRIGHT_BASE_URL: http://localhost:3000
        run: |
          echo "ğŸ§ª REGRESSION TEST EXECUTION"
          echo "ğŸŒ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ§ª Browser: Chromium"
          echo "ğŸ“‹ Running regression test suite (excluding @demo tests)"
          echo "============================================"
          
          # Crear directorios de reportes
          mkdir -p test-results
          mkdir -p playwright-report
          
          # Ejecutar tests de regresiÃ³n usando npm script (excluyendo @demo que fallan intencionalmente)
          npm run test:regression:dev:ci:no-demo

      - name: ğŸ“¸ Capture failure screenshots
        if: failure()
        run: |
          echo "ğŸ“¸ Capturing failure evidence..."
          find test-results -name "*.png" -o -name "*.webm" | head -10
          
          # Listar archivos de trace si existen
          find test-results -name "trace.zip" | head -5

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-results-${{ github.ref_name }}-${{ github.run_attempt }}
          path: |
            playwright-report/
            test-results/
            **/*.png
            **/*.webm
            **/*.zip
          retention-days: 14

      - name: ğŸ“‹ Generate test summary
        if: always()
        run: |
          echo "# ğŸ”„ REGRESSION TEST RESULTS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar resultados
          if [ -f "test-results/results.json" ]; then
            # Instalar jq si no estÃ¡ disponible
            which jq || sudo apt-get install -y jq
            
            passed=$(cat test-results/results.json | jq '.stats.passed' 2>/dev/null || echo "0")
            failed=$(cat test-results/results.json | jq '.stats.failed' 2>/dev/null || echo "0")
            skipped=$(cat test-results/results.json | jq '.stats.skipped' 2>/dev/null || echo "0")
            
            echo "## ğŸ“Š Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $passed |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $failed |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $skipped |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$failed" -gt 0 ]; then
              echo "## âŒ REGRESSION FAILED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- âš ï¸ $failed test(s) failed" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ” Check test reports for details" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ“ Artifacts available for download" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš« **DO NOT MERGE** until tests pass" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… REGRESSION PASSED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ¯ All tests passed successfully" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸš€ Ready for deployment" >> $GITHUB_STEP_SUMMARY
              echo "- ğŸ’ª Code quality validated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âš ï¸ NO TEST RESULTS FOUND" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not find test results file. Check workflow logs." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Detailed HTML reports available in workflow artifacts**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let status = 'âœ… All tests passed';
            let emoji = 'âœ…';
            
            // Check for failures
            try {
              if (fs.existsSync('test-results/results.json')) {
                const data = JSON.parse(fs.readFileSync('test-results/results.json', 'utf8'));
                if (data.stats.failed > 0) {
                  status = `âŒ ${data.stats.failed} test(s) failed`;
                  emoji = 'âŒ';
                }
              }
            } catch (e) {
              console.log('Could not read test results');
              status = 'âš ï¸ Could not determine test status';
              emoji = 'âš ï¸';
            }
            
            const summary = `## ${emoji} Regression Test Results
            
            **Status:** ${status}
            **Branch:** ${{ github.ref_name }}
            **Triggered by:** ${{ github.actor }}
            
            [ğŸ“Š View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ§ª Test Coverage
            - âœ… Login flows
            - âœ… CRUD operations  
            - âœ… Role-based access
            - âœ… Form validations
            - âœ… UI/UX components
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
    